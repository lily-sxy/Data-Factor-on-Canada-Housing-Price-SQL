(function WP$ChartSync$ChartSyncController$definition(){var j="jqHidden",i=".ajaxspinner",d="Status",c="IsDisplayed",f="EstimatedTimeLeft",h="application/json",b="function",a=null,g=$$WP.Common.Model,t=$$WP.Common.ModelCollection,e=$$WP.ChartSync.Synchronization,r=a,p=function WP$ChartSync$ChartSyncController$LoadConfiguredPollingInterval(a){var c={callback:a};if($$WP.ChartSync.ChartSyncController.ConfiguredPollingInterval&&a&&typeof a===b)a($$WP.ChartSync.ChartSyncController.ConfiguredPollingInterval);else $.ajax({url:makeLink("ChartSync/GetConfiguredPollingInterval"),type:"POST",contentType:h,success:$.proxy(n,c)})},s=1,m=1,o=10,q=60,n=function WP$ChartSync$ChartSyncController$s_onConfiguredPollingIntervalLoaded(c){var a=this.callback;$$WP.ChartSync.ChartSyncController.ConfiguredPollingInterval=c;a&&typeof a===b&&a(c)},l=function WP$ChartSync$ChartSyncController(g,d){var a=this;a.WP$Controllers$Controller();var c=$$WP.ChartSync.ChartSyncController;a.proxify("_onConfiguredPollingIntervalLoaded","_generateNewEstimatedTimeLeftString","_onTimerElapsedToDecrementEstimatedTimeLeft","_onSynchronizationAdded","_updateSynchronizationProgress","_onSynchronizationDisplayChanged","_onCancelButtonClicked","_onSynchronizationErrorChanged","_onSynchronizationStatusChanged");a._lightboxTemplate=d&&typeof d===b?d:$$WP.Templates.ChartSync.ChartSyncLightboxContent;a._hasUiComponent=g!==false;a._synchronizations=e.createSynchronizationCollection();a._intervalTimerIdsToDecrementEstimatedTimeLeft={};a._synchronizationListeners={};if(a._hasUiComponent)a._viewBinder=new c.CountdownTimerViewBinder(f,a._generateNewEstimatedTimeLeftString);if(!c.ConfiguredPollingInterval)c.LoadConfiguredPollingInterval(a._onConfiguredPollingIntervalLoaded);else a._pollingInterval=c.ConfiguredPollingInterval;a._addPropertyListeners()},u={_pollingInterval:a,_lightboxTemplate:a,_hasUiComponent:false,_viewBinder:a,_synchronizations:a,_intervalTimerIdsToDecrementEstimatedTimeLeft:a,_synchronizationListeners:a,_addPropertyListeners:function WP$ChartSync$ChartSyncController$_addPropertyListeners(){var a=this;a._synchronizations.addCollectionEventListener(t.AddEvent,a._onSynchronizationAdded);a._synchronizations.addPropertyListener(c,a._onSynchronizationDisplayChanged);a._synchronizations.addPropertyListener("Error",a._onSynchronizationErrorChanged);a._synchronizations.addPropertyListener(d,a._onSynchronizationStatusChanged)},syncPatient:function WP$ChartSync$ChartSyncController$syncPatient(g,k,d,c,i,j,h,f){var a,b;a=new e(g,k,d,c,i,j);this._setUpTimerToDecrementEstimatedTimeLeft(a.ModelId);b=s++;this._addListenerForSynchronization(a,b,f,h);this._synchronizations.add(a);return b},_setUpTimerToDecrementEstimatedTimeLeft:function WP$ChartSync$ChartSyncController$_setUpTimerToDecrementEstimatedTimeLeft(a){var b=m*1e3,c=window.setInterval(this._onTimerElapsedToDecrementEstimatedTimeLeft,b,a);this._addTimerToDecrementEstimatedTimeLeft(a,c)},_onTimerElapsedToDecrementEstimatedTimeLeft:function WP$ChartSync$ChartSyncController$_onTimerElapsedToDecrementEstimatedTimeLeft(b){var a=g.getInstance(b);if(!a||this._isSynchronizationComplete(a))this._clearTimerToDecrementEstimatedTimeLeft(b);else this._decrementEstimatedTimeLeft(a)},_decrementEstimatedTimeLeft:function WP$ChartSync$ChartSyncController$_decrementEstimatedTimeLeft(a){var b;if(a.EstimatedTimeLeft>0){b=a.EstimatedTimeLeft-m;a.setProperty(f,b)}},_onSynchronizationAdded:function WP$ChartSync$ChartSyncController$_onSynchronizationAdded(){this._pollingInterval&&this._startSynchronizationsThatNeedToBeRequested()},_startSynchronizationsThatNeedToBeRequested:function WP$ChartSync$ChartSyncController$_startSynchronizationsThatNeedToBeRequested(){var b,a;b=this._getSynchronizationsToRequest();for(a=0;a<b.length;a++)this._startSynchronization(b[a])},_getSynchronizationsToRequest:function WP$ChartSync$ChartSyncController$_getSynchronizationsToRequest(){var b,c,f,a;b=[];c=this._synchronizations.getFromIndex(d,e.SyncStatusEnum.NotRequested);for(f in c){a=g.getInstance(f);a&&$$WPUtil.IsNullOrEmpty(a.Error)&&b.push(a)}return b},_startSynchronization:function WP$ChartSync$ChartSyncController$_startSynchronization(b){var a=this;a._hasUiComponent&&!a._isCurrentlyDisplayingSynchronization()&&a._showSynchronization(b);a._updateSynchronizationProgress(b.ModelId)},_showSynchronization:function WP$ChartSync$ChartSyncController$_showSynchronization(a){if(!a||a.IsDisplayed||!this._hasUiComponent)return;a.setProperty(c,true)},_hideSynchronization:function WP$ChartSync$ChartSyncController$_hideSynchronization(a){if(!a||!a.IsDisplayed||!this._hasUiComponent)return;a.setProperty(c,false)},_onSynchronizationDisplayChanged:function WP$ChartSync$ChartSyncController$_onSynchronizationDisplayChanged(b){var c,a;for(c in b){a=b[c].model;if(b[c].to===true)this._showSynchronizationInLightbox(a);else this._removeSynchronizationLightbox(a)}},_showSynchronizationInLightbox:function WP$ChartSync$ChartSyncController$_showSynchronizationInLightbox(c){var b=this,g,e,d,f;resetLightbox();e=b._getViewModel(c);g=$afe.renderTemplate(b._lightboxTemplate,e);showLightBox(g.html());b._viewBinder.bindModel(c);$afe.select("#lightbox_overlay").prop("onclick",a);d='[data-view-binder-id="'+b._viewBinder.ViewBinderId+'"]';d+='[data-model-id="'+c.ModelId+'"]';f=$afe.select(d);f.on("click",".button.cancelworkflow",c.ModelId,b._onCancelButtonClicked)},_getViewModel:function WP$ChartSync$ChartSyncController$_getViewModel(a){return{ViewBinderId:this._viewBinder.ViewBinderId,Synchronization:a}},_onCancelButtonClicked:function WP$ChartSync$ChartSyncController$_onCancelButtonClicked(c){var b,a;b=c.data;a=g.getInstance(b);a&&!this._isSynchronizationComplete(a)&&a.setProperty(d,e.SyncStatusEnum.Canceled)},_removeSynchronizationLightbox:function WP$ChartSync$ChartSyncController$_hideSynchronizationInLightbox(){hideLightbox();resetLightbox()},_updateSynchronizationProgress:function WP$ChartSync$ChartSyncController$_updateSynchronizationProgress(b){var a=g.getInstance(b);this._shouldRequestNewSynchronizationProgress(a)&&this._sendRequestForNewSynchronizationProgress(a)},_shouldRequestNewSynchronizationProgress:function WP$ChartSync$ChartSyncController$_shouldRequestNewSynchronizationProgress(a){return a&&!this._isSynchronizationComplete(a)},_sendRequestForNewSynchronizationProgress:function WP$ChartSync$ChartSyncController$_sendRequestForNewSynchronizationProgress(c){var a=this,d,b,e;d=a._getPatientChartUpToDateRequestObject(c);b=JSON.stringify(d);e={ChartSyncController:a,SynchronizationId:c.ModelId};a._shouldHideDefaultAjaxSpinner()&&a._hideDefaultAjaxSpinner();$.ajax({url:makeLink("ChartSync/GetPatientChartUpToDate"),type:"POST",contentType:h,success:$.proxy(a._onNewSynchronizationProgress,e),data:b})},_getPatientChartUpToDateRequestObject:function WP$ChartSync$ChartSyncController$_getPatientChartUpToDateRequestObject(a){return{PatientCid:a.PatientCid,UserCid:a.UserCid,ApplicationId:a.ApplicationId,homeDeploymentInternalId:a.homeDeploymentInternalId,Priority:a.Priority,SyncType:a.SyncType}},_onNewSynchronizationProgress:function WP$ChartSync$ChartSyncController$_onNewSynchronizationProgress(c){var f,a,e,b,h;f=this;a=f.ChartSyncController;e=f.SynchronizationId;b=g.getInstance(e);a._shouldHideDefaultAjaxSpinner()&&a._unhideDefaultAjaxSpinner();if(b&&!a._isSynchronizationComplete(b)){a._synchronizations.openChangeBatch();b.setProperty(d,c.Status);b.setProperty("Error",c.Error);a._updateEstimatedTimeLeft(b,c.EstimatedTimeLeft);a._synchronizations.closeChangeBatch();h=a._pollingInterval*1e3;window.setTimeout(a._updateSynchronizationProgress,h,e)}},_updateEstimatedTimeLeft:function WP$ChartSync$chartSyncController(e,d){var b,c;b=e.EstimatedTimeLeft;c=Math.abs(b-d);(b===a||c>o)&&e.setProperty(f,d)},_onSynchronizationErrorChanged:function WP$ChartSync$ChartSyncController$_onSynchronizationErrorChanged(a){this._onSynchronizationStatusChanged(a)},_onSynchronizationStatusChanged:function WP$ChartSync$ChartSyncController$_onSynchronizationStatusChanged(c){var b,a;for(b in c){a=c[b].model||$$WP.Common.Model.getInstance(b);this._isSynchronizationComplete(a)&&this._onSynchronizationComplete(a)}},_onSynchronizationComplete:function WP$ChartSync$ChartSyncController$_onSynchronizationComplete(a){var d=this,h,g,c,e,f;h=d._getListenerIdForSynchronization(a);g=d._getContextDataForSynchronization(a);c=d._getCallbackForSynchronization(a);e=a.Status;f=a.Error;d._removeSynchronization(a);c&&typeof c===b&&c(h,e,f,g)},_removeSynchronization:function WP$ChartSync$ChartSyncController$_removeSynchronization(a){this._hideSynchronization(a);this._removeListenerForSynchronization(a);this._synchronizations.remove(a);a.dispose()},_generateNewEstimatedTimeLeftString:function WP$ChartSync$ChartSyncController$_generateNewEstimatedTimeLeftString(d){var b="@MYCHART@COUNTDOWN@",a="ChartSync.ChartSyncLightBox",c;if(d<=q)c=$$WP.Strings.get("EstimatedTimeLeftUnderAMinute",a);else{$$WP.Strings.addMnemonic(b,d);c=$$WP.Strings.get("EstimatedTimeLeftInSeconds",a);$$WP.Strings.removeMnemonic(b)}return c},_onConfiguredPollingIntervalLoaded:function WP$ChartSync$ChartSyncController$_onConfiguredPollingIntervalLoaded(a){this._pollingInterval=a;this._startSynchronizationsThatNeedToBeRequested()},_isCurrentlyDisplayingSynchronization:function WP$ChartSync$ChartSyncController$_isCurrentlyDisplayingSynchronization(){return this._synchronizations.getFromIndex(c,true)!==a},_isSynchronizationComplete:function WP$ChartSync$ChartSyncController$_isSynchronizationComplete(a){return a.Status===e.SyncStatusEnum.UpToDate||a.Status===e.SyncStatusEnum.Canceled||a.Status===e.SyncStatusEnum.UnknownError||!$$WPUtil.IsNullOrEmpty(a.Error)},_addListenerForSynchronization:function WP$ChartSync$ChartSyncController$_addListenerForSynchronization(a,d,c,e){var b={listenerId:d,contextData:c,callback:e};this._synchronizationListeners[a.ModelId]=b},_getListenerIdForSynchronization:function WP$ChartSync$ChartSyncController$_getListenerIdForSynchronization(a){return this._synchronizationListeners[a.ModelId].listenerId},_getContextDataForSynchronization:function WP$ChartSync$ChartSyncController$_getContextDataForSynchronization(a){return this._synchronizationListeners[a.ModelId].contextData},_getCallbackForSynchronization:function WP$ChartSync$ChartSyncController$_getCallbackForSynchronization(a){return this._synchronizationListeners[a.ModelId].callback},_removeListenerForSynchronization:function WP$ChartSync$ChartSyncController$_removeListenerForSynchronization(a){delete this._synchronizationListeners[a.ModelId]},_addTimerToDecrementEstimatedTimeLeft:function WP$ChartSync$ChartSyncController$_addTimerToDecrementEstimatedTimeLeft(a,b){this._intervalTimerIdsToDecrementEstimatedTimeLeft[a]=b},_clearTimerToDecrementEstimatedTimeLeft:function WP$ChartSync$ChartSyncController$_clearTimerToDecrementEstimatedTimeLeft(a){var b=this._intervalTimerIdsToDecrementEstimatedTimeLeft[a];window.clearInterval(b);delete this._intervalTimerIdsToDecrementEstimatedTimeLeft[a]},_shouldHideDefaultAjaxSpinner:function WP$ChartSync$ChartSyncController$_shouldHideDefaultAjaxSpinner(){return this._isPrelogin()&&this._hasUiComponent},_isPrelogin:function WP$ChartSync$ChartSyncController$_isPrelogin(){return $afe.select("body").hasClass("isPrelogin")},_hideDefaultAjaxSpinner:function WP$ChartSync$ChartSyncController$_hideDefaultAjaxSpinner(){$afe.select(i).addClass(j)},_unhideDefaultAjaxSpinner:function WP$ChartSync$ChartSyncController$_unhideDefaultAjaxSpinner(){$afe.select(i).removeClass(j)}},k=function WP$ChartSync$CountdownTimerViewBinder(d,c){this.WP$Common$ViewBinder(a,[d]);(!c||typeof c!==b)&&$$WP.Debug.logError("StringGenerationFunction needs to be a function");this._stringGenerationFunction=c};k.prototype={_stringGenerationFunction:a,_onPropertyChanged:function(f,e){var c,b,a,d;c=this.getBoundElements(f);b=e.to;a=this._stringGenerationFunction(b);d=c.find(".countdown").text(a)}};l.prototype=u;l.extend($$WP.Controllers.Controller,"WP$ChartSync$ChartSyncController");k.extend($$WP.Common.ViewBinder,"WP$ChartSync$CountdownTimerViewBinder");$$WP.ChartSync=$$WP.ChartSync||{};$$WP.ChartSync.ChartSyncController=l;$$WP.ChartSync.ChartSyncController.ConfiguredPollingInterval=r;$$WP.ChartSync.ChartSyncController.LoadConfiguredPollingInterval=p;$$WP.ChartSync.ChartSyncController.CountdownTimerViewBinder=k})()